<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Jason Willwerscheid" />


<title>Comparing methods for fitting flash to single-cell data</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>



<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">scFLASH</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/willwerscheid/scFLASH">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Comparing methods for fitting flash to single-cell data</h1>
<h4 class="author">Jason Willwerscheid</h4>
<h4 class="date">3/17/2019</h4>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span> workflowr <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#report"> Report <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> </a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2019-04-08
</p>
<p>
<strong>Checks:</strong> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> 6 <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span> 0
</p>
<p>
<strong>Knit directory:</strong> <code>scFLASH/</code> <span class="glyphicon glyphicon-question-sign" aria-hidden="true" title="This is the local directory in which the code in this file was executed."> </span>
</p>
<p>
This reproducible <a href="http://rmarkdown.rstudio.com">R Markdown</a> analysis was created with <a
  href="https://github.com/jdblischak/workflowr">workflowr</a> (version 1.2.0). The <em>Report</em> tab describes the reproducibility checks that were applied when the results were created. The <em>Past versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="report" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguptodate"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>R Markdown file:</strong> up-to-date </a>
</p>
</div>
<div id="strongRMarkdownfilestronguptodate" class="panel-collapse collapse">
<div class="panel-body">
<p>Great! Since the R Markdown file has been committed to the Git repository, you know the exact version of the code that produced these results.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Environment:</strong> empty </a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the global environment can affect the analysis in your R Markdown file in unknown ways. For reproduciblity it’s best to always run the code in an empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20181103code"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Seed:</strong> <code>set.seed(20181103)</code> </a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20181103code" class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20181103)</code> was run prior to running the code in the R Markdown file. Setting a seed ensures that any results that rely on randomness, e.g. subsampling or permutations, are reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Session information:</strong> recorded </a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package versions is critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongnone"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Cache:</strong> none </a>
</p>
</div>
<div id="strongCachestrongnone" class="panel-collapse collapse">
<div class="panel-body">
<p>Nice! There were no cached chunks for this analysis, so you can be confident that you successfully produced the results during this run.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongahrefhttpsgithubcomwillwerscheidscFLASHtree395b82c9509cd938be6a79c466e35002e1a4f12atargetblank395b82ca"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Repository version:</strong> <a href="https://github.com/willwerscheid/scFLASH/tree/395b82c9509cd938be6a79c466e35002e1a4f12a" target="_blank">395b82c</a> </a>
</p>
</div>
<div id="strongRepositoryversionstrongahrefhttpsgithubcomwillwerscheidscFLASHtree395b82c9509cd938be6a79c466e35002e1a4f12atargetblank395b82ca" class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development and connecting the code version to the results is critical for reproducibility. The version displayed above was the version of the Git repository at the time these results were generated. <br><br> Note that you need to be careful to ensure that all relevant files for the analysis have been committed to Git prior to generating the results (you can use <code>wflow_publish</code> or <code>wflow_git_commit</code>). workflowr only checks the R Markdown file, but you know if there are other scripts or data files that it depends on. Below is the status of the Git repository when the results were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    .Rproj.user/

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not included in this status report because it is ok for generated content to have uncommitted changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">

<p>
These are the previous versions of the R Markdown and HTML files. If you’ve configured a remote Git repository (see <code>?wflow_git_remote</code>), click on the hyperlinks in the table below to view them.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/395b82c9509cd938be6a79c466e35002e1a4f12a/analysis/sc_comparisons.Rmd" target="_blank">395b82c</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-08
</td>
<td>
workflowr::wflow_publish(“analysis/sc_comparisons.Rmd”)
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/willwerscheid/scFLASH/047bb2f3c013a9db842ecf7a1646faef932ce478/docs/sc_comparisons.html" target="_blank">047bb2f</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-05
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/5c408417ac47251433806645a599025b9838680e/analysis/sc_comparisons.Rmd" target="_blank">5c40841</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-05
</td>
<td>
wflow_publish(“analysis/sc_comparisons.Rmd”)
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/willwerscheid/scFLASH/8a15568b4a20547ba22c9b8b5de943e30a93cfcc/docs/sc_comparisons.html" target="_blank">8a15568</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-01
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/57d374a362662a09b302465a7b76bcce42645b6b/analysis/sc_comparisons.Rmd" target="_blank">57d374a</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-01
</td>
<td>
wflow_publish(“analysis/sc_comparisons.Rmd”)
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/willwerscheid/scFLASH/cb2c9c5ddb54ee27666a9bc55997256b2b7f40e5/docs/sc_comparisons.html" target="_blank">cb2c9c5</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-03-25
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/d4e825505480c6837454945ee399204689a82757/analysis/sc_comparisons.Rmd" target="_blank">d4e8255</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-03-25
</td>
<td>
wflow_publish(“analysis/sc_comparisons.Rmd”)
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/willwerscheid/scFLASH/60843e039ef239f2434a2c5a38ad6d64facda2f3/docs/sc_comparisons.html" target="_blank">60843e0</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-03-22
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/b792cfefaff6c69992dfdc4eae61a6a0c00b1326/analysis/sc_comparisons.Rmd" target="_blank">b792cfe</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-03-22
</td>
<td>
wflow_publish(“analysis/sc_comparisons.Rmd”)
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Here I compare various methods for fitting flash objects to single-cell data. I use the drop-seq dataset discussed in <a href="https://www.nature.com/articles/s41586-018-0393-7">Montoro et al.</a>, which includes counts for approximately 18000 genes and 7000 cells. Close to 90% of counts are equal to zero.</p>
<p>I perform 50 trials. For each trial, I subsample 200 cells, then I subsample 500 genes from the set of genes that have at least 3 non-zero counts among the subsampled cells. I remove 1000 entries at random from the resulting data matrix, fit a series of flash objects, and calculate mean squared errors on the log1p scale, using flash posterior means as fitted values and the original data as ground truth. I compare different variance structures, data transformations, scaling methods, priors, and numbers of factors.</p>
<p>Additionally, to paint a more granular picture of how additional factors affect mean squared error, I incrementally fit “greedy” flash objects with 1 to 60 factors using the full drop-seq dataset (not just a subsample).</p>
</div>
<div id="code" class="section level2">
<h2>Code</h2>
<p>Click “Code” to view the code used to run the tests.</p>
<pre class="r"><code># library(ashr) -- uncomment after negative mixture proportions bug is fixed
devtools::load_all(&quot;~/Github/ashr&quot;)
# library(flashier) -- uncomment after pushing 0.1.1 updates to master
devtools::load_all(&quot;~/Github/flashier&quot;)
library(Matrix)
library(ggplot2)


# Load data ---------------------------------------------------------------

# The drop-seq dataset in Montoro et al. can be downloaded here:
#     https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE103354
trachea &lt;- read.table(&quot;./data/GSE103354_Trachea_droplet_UMIcounts.txt&quot;)
trachea &lt;- as.matrix(trachea)
trachea &lt;- Matrix(trachea)


# Set test parameters -----------------------------------------------------

# Number of times to subsample data and run fits.
ntrials &lt;- 50

# Size of subsampled data matrices.
ncells &lt;- 200
ngenes &lt;- 500

# Minimum number of nonzero counts needed to include a gene.
min.cts &lt;- 3

# Proportion of entries to impute.
prop.missing &lt;- 0.01
nmissing &lt;- ceiling(prop.missing * ncells * ngenes)

# Number of factors to add to each fit.
K &lt;- 5

# &quot;Nonmissingness threshold&quot;, which deals with an issue that can occur when
#   some data is missing. I will discuss it elsewhere.
nonmissing.thresh &lt;- c(0.5, 0.5)

# Verbose flag for flashier output.
verbose &lt;- FALSE


# Set up data frames ------------------------------------------------------

create.df &lt;- function(names) {
  names &lt;- paste0(names, &quot;.&quot;)
  df.names &lt;- outer(names, c(&quot;mse&quot;, &quot;elbo&quot;), FUN = paste0)
  df &lt;- data.frame(rep(list(numeric(0)), length(df.names)))
  names(df) &lt;- t(df.names)
  return(df)
}

# Test 1: variance structure.
var.df &lt;- create.df(c(&quot;constant&quot;, &quot;genewise&quot;, &quot;fixed&quot;, &quot;noisyA&quot;, &quot;noisyB&quot;))

# Test 2: data transformation.
trans.df &lt;- create.df(c(&quot;log1p&quot;, &quot;anscombe&quot;, &quot;arcsin&quot;, &quot;raw&quot;, &quot;pearson&quot;))

# Test 3: normalization method.
norm.df &lt;- create.df(c(&quot;none&quot;, &quot;fitmean&quot;, &quot;scale&quot;))

# Test 4: prior type.
prior.df &lt;- create.df(c(&quot;normal&quot;, &quot;nngeneA&quot;, &quot;nngeneB&quot;, &quot;nncellA&quot;, &quot;nncellB&quot;))

# Test 5: number of factors and backfit.
nfactors.df &lt;- create.df(c(&quot;g1&quot;, &quot;bf1&quot;, &quot;g2&quot;, &quot;bf2&quot;, &quot;g3&quot;, &quot;bf3&quot;))


# Functions for populating data frames ------------------------------------

get.fitted &lt;- function(fl) {
  # Get fitted values on the log1p scale.
  fitted.vals &lt;- flashier:::lowrank.expand(fl$fit$EF)
  # Convert to raw counts.
  return(exp(fitted.vals) - 1)
}

log1p.mse &lt;- function(true, preds) {
  # Threshold out negative counts.
  preds &lt;- pmax(preds, 0)
  return(mean((log1p(true) - log1p(preds))^2))
}

get.elbo &lt;- function(fl, adjustment) {
  return(fl$objective + adjustment)
}

all.metrics &lt;- function(data, missing.vals,
                        fl, fitted.vals, elbo.adjustment) {
  missing.idx &lt;- which(is.na(data))
  if (is.null(fitted.vals)) {
    fitted.vals &lt;- get.fitted(fl)
  }
  return(list(mse = log1p.mse(missing.vals, fitted.vals[missing.idx]),
              elbo = get.elbo(fl, elbo.adjustment)))
}

get.df.row &lt;- function(data, missing.vals,
                       fl.list,
                       mean.factors = NULL,
                       fitted.vals = NULL,
                       elbo.adjustment = NULL) {
  if (is.null(fitted.vals)) {
    fitted.vals = rep(list(NULL), length(fl.list))
  }
  if (is.null(elbo.adjustment)) {
    elbo.adjustment = rep(list(0), length(fl.list))
  }

  return(unlist(mapply(all.metrics,
                       fl = fl.list,
                       fitted.vals = fitted.vals,
                       elbo.adjustment = elbo.adjustment,
                       MoreArgs = list(data = data,
                                       missing.vals = missing.vals))))
}


# Run tests ---------------------------------------------------------------

for (i in 1:ntrials) {
  cat(&quot;TRIAL&quot;, i, &quot;\n&quot;)

  set.seed(i)
  rand.cells &lt;- sample(1:ncol(trachea), ncells)
  samp &lt;- trachea[, rand.cells]

  rand.genes &lt;- sample(which(rowSums(samp &gt; 0) &gt;= min.cts), ngenes)
  samp &lt;- samp[rand.genes, ]

  missing.idx &lt;- sort(sample(1:length(samp), nmissing))
  missing.vals &lt;- samp[missing.idx]
  samp[missing.idx] &lt;- NA

  # Test 1: variance structure.
  cat(&quot;  Running variance structure tests.\n&quot;)

  fl.var0 &lt;- flashier(log1p(samp), var.type = 0,
                      prior.type = &quot;normal.mix&quot;,
                      greedy.Kmax = K + 1, backfit = &quot;none&quot;,
                      nonmissing.thresh = nonmissing.thresh,
                      verbose.lvl = 1L * verbose)

  fl.var1 &lt;- flashier(log1p(samp), var.type = 1,
                      prior.type = &quot;normal.mix&quot;,
                      greedy.Kmax = K + 1, backfit = &quot;none&quot;,
                      nonmissing.thresh = nonmissing.thresh,
                      verbose.lvl = 1L * verbose)

  S &lt;- sqrt(samp) / (samp + 1)
  nz.prop &lt;- sum(samp &gt; 0, na.rm = TRUE) / (length(samp) - length(missing.idx))
  S[S == 0] &lt;- sqrt(nz.prop) / (nz.prop + 1)

  fl.fixS &lt;- flashier(log1p(samp), S = S,
                      var.type = NULL,
                      prior.type = &quot;normal.mix&quot;,
                      greedy.Kmax = K + 1, backfit = &quot;none&quot;,
                      nonmissing.thresh = nonmissing.thresh,
                      verbose.lvl = 1L * verbose)

  suppressMessages({
    fl.noisyA &lt;- flashier(log1p(samp), S = S,
                          var.type = 0,
                          prior.type = &quot;normal.mix&quot;,
                          greedy.Kmax = K + 1, backfit = &quot;none&quot;,
                          nonmissing.thresh = nonmissing.thresh,
                          verbose.lvl = 1L * verbose)
  })

  suppressMessages({
    fl.noisyB &lt;- flashier(log1p(samp), S = sqrt(samp) / (samp + 1),
                          var.type = 0,
                          prior.type = &quot;normal.mix&quot;,
                          greedy.Kmax = K + 1, backfit = &quot;none&quot;,
                          nonmissing.thresh = nonmissing.thresh,
                          verbose.lvl = 1L * verbose)
  })

  var.df[i, ] &lt;- get.df.row(samp, missing.vals,
                            fl.list = list(fl.var0, fl.var1, fl.fixS,
                                           fl.noisyA, fl.noisyB))

  # Test 2: data transformation.
  cat(&quot;  Running data transformation tests.\n&quot;)

  fl.log1p &lt;- fl.var0
  log1p.adj &lt;- -sum(log1p(samp), na.rm = TRUE)

  fl.ans &lt;- flashier(sqrt(samp + 0.375), var.type = 0,
                     prior.type = &quot;normal.mix&quot;,
                     greedy.Kmax = K + 1, backfit = &quot;none&quot;,
                     nonmissing.thresh = nonmissing.thresh,
                     verbose.lvl = 1L * verbose)
  ans.fitted &lt;- flashier:::lowrank.expand(fl.ans$fit$EF)^2 - 0.375
  ans.adj &lt;- -sum(log(2) + 0.5 * log(samp + 0.375), na.rm = TRUE)

  cell.sums &lt;- colSums(samp, na.rm = TRUE)
  props &lt;- samp / rep(cell.sums, each = nrow(samp))
  fl.arcsin &lt;- flashier(asin(sqrt(props)), var.type = 0,
                        prior.type = &quot;normal.mix&quot;,
                        greedy.Kmax = K + 1, backfit = &quot;none&quot;,
                        nonmissing.thresh = nonmissing.thresh,
                        verbose.lvl = 1L * verbose)
  arcsin.fitted &lt;- (sin(flashier:::lowrank.expand(fl.arcsin$fit$EF)^2)
                    * rep(cell.sums, each = nrow(samp)))
  arcsin.adj &lt;- NA

  fl.raw &lt;- flashier(props, var.type = 0,
                     prior.type = &quot;normal.mix&quot;,
                     greedy.Kmax = K + 1, backfit = &quot;none&quot;,
                     nonmissing.thresh = nonmissing.thresh,
                     verbose.lvl = 1L * verbose)
  raw.fitted &lt;- (flashier:::lowrank.expand(fl.raw$fit$EF)
                 * rep(cell.sums, each = nrow(samp)))
  raw.adj &lt;- -sum(rep(log(cell.sums), each = nrow(samp))[-missing.idx])

  gene.props &lt;- rowSums(samp, na.rm = TRUE) / sum(samp, na.rm = TRUE)
  mu &lt;- outer(gene.props, cell.sums)
  sd.mat &lt;- sqrt(mu - mu^2 / rep(cell.sums, each = nrow(samp)))
  resid &lt;- (samp - mu) / sd.mat

  fl.pearson &lt;- flashier(resid, var.type = 0,
                         prior.type = &quot;normal.mix&quot;,
                         greedy.Kmax = K + 1, backfit = &quot;none&quot;,
                         nonmissing.thresh = nonmissing.thresh,
                         verbose.lvl = 1L * verbose)
  pearson.fitted &lt;- mu + sd.mat * flashier:::lowrank.expand(fl.pearson$fit$EF)
  pearson.adj &lt;- -sum(log(sd.mat)[-missing.idx])

  trans.df[i, ] &lt;- get.df.row(samp, missing.vals,
                              fl.list = list(fl.log1p, fl.ans, fl.arcsin,
                                             fl.raw, fl.pearson),
                              fitted.vals = list(get.fitted(fl.log1p),
                                                 ans.fitted, arcsin.fitted,
                                                 raw.fitted, pearson.fitted),
                              elbo.adjustment = list(log1p.adj,
                                                     ans.adj, arcsin.adj,
                                                     raw.adj, pearson.adj))

  # Test 3: scaling method.
  cat(&quot;  Running scaling tests.\n&quot;)

  fl.none &lt;- fl.var0
  none.adj &lt;- log1p.adj

  fl.ones &lt;- flashier(log1p(samp), var.type = 0,
                      prior.type = &quot;normal.mix&quot;,
                      fixed.factors = c(ones.factor(2), ones.factor(1)),
                      greedy.Kmax = K,
                      backfit.after = 2, final.backfit = FALSE,
                      nonmissing.thresh = nonmissing.thresh,
                      verbose.lvl = 1L * verbose)
  ones.adj &lt;- log1p.adj

  scaled.samp &lt;- samp * median(cell.sums) / rep(cell.sums, each = nrow(samp))
  fl.scale &lt;- flashier(log1p(scaled.samp), var.type = 0,
                       prior.type = &quot;normal.mix&quot;,
                       fixed.factors = ones.factor(2),
                       greedy.Kmax = K, backfit = &quot;none&quot;,
                       nonmissing.thresh = nonmissing.thresh,
                       verbose.lvl = 1L * verbose)
  scale.fitted &lt;- (get.fitted(fl.scale)
                   * rep(cell.sums, each = nrow(samp)) / median(cell.sums))
  scale.adj &lt;- sum(log(median(cell.sums)) - rep(log(cell.sums), each = nrow(samp))
                   - log1p(scaled.samp), na.rm = TRUE)

  norm.df[i, ] &lt;- get.df.row(samp, missing.vals,
                             fl.list = list(fl.none, fl.ones, fl.scale),
                             fitted.vals = list(get.fitted(fl.none),
                                                get.fitted(fl.ones),
                                                scale.fitted),
                             elbo.adjustment = list(none.adj, ones.adj,
                                                    scale.adj))

  # Test 4: prior type.
  cat(&quot;  Running prior type tests.\n&quot;)

  fl.normalmix &lt;- fl.var0

  fl.nngenes &lt;- flashier(log1p(samp), var.type = 0,
                         prior.type = c(&quot;nonnegative&quot;, &quot;normal.mix&quot;),
                         greedy.Kmax = K + 1, backfit = &quot;none&quot;,
                         nonmissing.thresh = nonmissing.thresh,
                         verbose.lvl = 1L * verbose)

  fl.nngenes.pm &lt;- flashier(log1p(samp), var.type = 0,
                            prior.type = c(&quot;nonnegative&quot;, &quot;normal.mix&quot;),
                            ash.param = list(method = &quot;fdr&quot;),
                            greedy.Kmax = K + 1, backfit = &quot;none&quot;,
                            nonmissing.thresh = nonmissing.thresh,
                            verbose.lvl = 1L * verbose)

  fl.nncells &lt;- flashier(log1p(samp), var.type = 0,
                         prior.type = c(&quot;normal.mix&quot;, &quot;nonnegative&quot;),
                         greedy.Kmax = K + 1, backfit = &quot;none&quot;,
                         nonmissing.thresh = nonmissing.thresh,
                         verbose.lvl = 1L * verbose)

  fl.nncells.pm &lt;- flashier(log1p(samp), var.type = 0,
                            prior.type = c(&quot;normal.mix&quot;, &quot;nonnegative&quot;),
                            ash.param = list(method = &quot;fdr&quot;),
                            greedy.Kmax = K + 1, backfit = &quot;none&quot;,
                            nonmissing.thresh = nonmissing.thresh,
                            verbose.lvl = 1L * verbose)

  prior.df[i, ] &lt;- get.df.row(samp, missing.vals,
                              fl.list = list(fl.normalmix,
                                             fl.nngenes, fl.nngenes.pm,
                                             fl.nncells, fl.nncells.pm))

  # Test 5: number of factors and backfit.
  cat(&quot;  Running backfitting tests.\n&quot;)

  fl.g &lt;- fl.var0

  fl.b &lt;- flashier(flash.init = fl.g, backfit = &quot;only&quot;,
                   backfit.reltol = 10,
                   verbose.lvl = 3L * verbose)

  # Add K more factors, then K more.
  fl.g2 &lt;- flashier(flash.init = fl.g,
                    greedy.Kmax = K, backfit = &quot;none&quot;,
                    verbose.lvl = 1L * verbose)
  fl.b2 &lt;- flashier(flash.init = fl.b,
                    greedy.Kmax = K, backfit = &quot;final&quot;,
                    backfit.reltol = 10,
                    verbose.lvl = 3L * verbose)
  fl.g3 &lt;- flashier(flash.init = fl.g2,
                    greedy.Kmax = K, backfit = &quot;none&quot;,
                    verbose.lvl = 1L * verbose)
  fl.b3 &lt;- flashier(flash.init = fl.b2,
                    greedy.Kmax = K, backfit = &quot;final&quot;,
                    backfit.reltol = 10,
                    verbose.lvl = 3L * verbose)

  nfactors.df[i, ] &lt;- get.df.row(samp, missing.vals,
                                 fl.list = list(fl.g, fl.b,
                                                fl.g2, fl.b2,
                                                fl.g3, fl.b3))
}

# Test 6: incremental addition of factors

set.seed(666)
data &lt;- log1p(trachea[rowSums(trachea &gt; 0) &gt;= min.cts, ])
missing.idx &lt;- sample(1:length(data), ceiling(prop.missing * length(data)))
true.vals &lt;- exp(data[missing.idx]) - 1
data[missing.idx] &lt;- NA

Kmax &lt;- 60

fl &lt;- flashier(data, var.type = 0,
               prior.type = &quot;point.normal&quot;,
               fixed.factors = c(ones.factor(1), ones.factor(2)),
               backfit.after = 2, final.backfit = FALSE,
               greedy.Kmax = 1,
               final.nullchk = FALSE,
               nonmissing.thresh = nonmissing.thresh,
               verbose.lvl = 3)
mse.vec &lt;- log1p.mse(true.vals, get.fitted(fl)[missing.idx])

for (k in 2:Kmax) {
  fl &lt;- flashier(flash.init = fl,
                 greedy.Kmax = 1, backfit = &quot;none&quot;,
                 final.nullchk = FALSE,
                 verbose.lvl = 3)
  mse.vec &lt;- c(mse.vec,
               log1p.mse(true.vals, get.fitted(fl)[missing.idx]))
}

mse.diff &lt;- c(NA, mse.vec[2:length(mse.vec)] - mse.vec[1:(length(mse.vec) - 1)])
mse.df &lt;- data.frame(k = 1:Kmax, mse = mse.vec, mse.diff = mse.diff)


# Save results ------------------------------------------------------------

all.res &lt;- list(var.df = var.df,
                trans.df = trans.df,
                norm.df = norm.df,
                prior.df = prior.df,
                nfactors.df = nfactors.df,
                mse.df = mse.df)
saveRDS(all.res, &quot;./output/sc_comparisons/allres.rds&quot;)</code></pre>
<pre class="r"><code>allres &lt;- readRDS(&quot;./output/sc_comparisons/allres.rds&quot;)</code></pre>
</div>
<div id="introduction-to-plots" class="section level2">
<h2>Introduction to plots</h2>
<p>For each comparison, I choose a “reference” method and plot the difference in mean squared error for each other method over all 50 trials. A positive value indicates worse performance. Importantly, mean squared error is calculated on the log1p scale in all cases. The red horizontal lines indicate the median and the 10% and 90% quantiles.</p>
<p>For reference, I also plot (usually without comment) differences in ELBO, adjusting via a change-of-variables formula where necessary. In principle, a higher ELBO should indicate a better fit.</p>
</div>
<div id="variance-structures" class="section level2">
<h2>Variance structures</h2>
<p>The most commonly used transformations of single-cell data are log transforms with pseudocounts. Throughout these tests, my default procedure is to transform the raw counts using the log1p transform: <span class="math display">\[ Y_{ij} = \log \left( X_{ij} + 1 \right) \]</span></p>
<p>Thus, the model that <code>flashier</code> fits is <span class="math display">\[ \log \left( X_{ij} + 1 \right) = \sum_k L_{ik} F_{jk} + E_{ij}, \]</span> with <span class="math display">\[E_{ij} \sim N(0, \sigma_{ij}^2)\]</span></p>
<p>If one disregards sampling error, one can simply fit a constant variance structure <span class="math inline">\(\sigma_{ij}^2 = \sigma^2\)</span> or a gene-wise variance structure <span class="math inline">\(\sigma_{ij}^2 = \sigma_j^2\)</span>, with <span class="math inline">\(\sigma^2\)</span> (viz. <span class="math inline">\(\sigma_j^2\)</span>) to be estimated.</p>
<p>However, if (as is reasonable to assume) the data is Poisson for some true expression levels <span class="math inline">\(\lambda_{ij}\)</span>: <span class="math display">\[ X_{ij} \sim \text{Poisson} (\lambda_{ij}), \]</span> then sampling errors will be much different for large and small counts. Expanding around the MLE <span class="math inline">\(\hat{\lambda}_{ij} = X_{ij}\)</span>: <span class="math display">\[ \log (\lambda_{ij} + 1) 
\approx \log(X_{ij} + 1) + \frac{\lambda_{ij} 
- X_{ij}}{X_{ij} + 1} \]</span> so that <span class="math display">\[ \text{Var} \left( \log (\lambda_{ij} + 1) \right)
\approx \frac{\lambda_{ij}}{(X_{ij} + 1)^2} 
\approx \frac{X_{ij}}{(X_{ij} + 1)^2}\]</span> Ignoring approximation error, one can thus fix the standard errors at <span class="math display">\[ S_{ij} = \frac{\sqrt{X_{ij}}}{X_{ij} + 1} \]</span> Unfortunately, this sets <span class="math inline">\(S_{ij} = 0\)</span> when <span class="math inline">\(X_{ij} = 0\)</span>. To circumvent this problem, I replace zeros with a very rough estimate of the baseline Poisson noise: <span class="math display">\[ \lambda_0 := \frac{\#\{X_{ij}: X_{ij} \ne 0\}}{\#\{X_{ij}\}} \]</span> That is, when <span class="math inline">\(X_{ij} = 0\)</span>, I set <span class="math display">\[ S_{ij} = \frac{\sqrt{\lambda_0}}{\lambda_0 + 1} \]</span></p>
<p>Using <code>flashier</code>, one can also fit a model that includes both fixed sampling errors and an approximation error to be estimated, so that <span class="math display">\[E_{ij} \sim N(0, S_{ij}^2 + \sigma^2)\]</span> I try two approaches. One fixes the standard errors as described above, replacing <span class="math inline">\(S_{ij} = 0\)</span> with <span class="math inline">\(S_{ij} = \sqrt{\lambda_0} / (\lambda_0 + 1)\)</span>. The other leaves standard errors of zero as they are and hopes that the estimated <span class="math inline">\(\sigma^2\)</span> will be able to make up the difference. In both cases, the estimated <span class="math inline">\(\sigma^2\)</span> is constant across genes and cells (estimating a noisy gene-wise variance structure is at present far too slow for large datasets).</p>
<pre class="r"><code>library(ggplot2)

get.plot.df &lt;- function(df, ref.lvl, type) {
  tests &lt;- colnames(df)
  category &lt;- sapply(strsplit(tests, &#39;[.]&#39;), `[`, 1)
  metric &lt;- sapply(strsplit(tests, &#39;[.]&#39;), `[`, 2)
  df &lt;- df[, which(metric == type)]
  category &lt;- category[which(metric == type)]
  which.ref &lt;- which(category == ref.lvl)
  df &lt;- df - df[, which.ref]
  df &lt;- df[, -which.ref]
  category &lt;- category[-which.ref]
  
  return(data.frame(value = as.vector(as.matrix(df)), 
                    category = rep(category, each = nrow(df))))
}

do.plots &lt;- function(df, ref.lvl, title, xlimits, xlabels) {
  mse.df &lt;- get.plot.df(df, ref.lvl, type = &quot;mse&quot;)
  elbo.df &lt;- get.plot.df(df, ref.lvl, type = &quot;elbo&quot;)
  
  mse.plot &lt;- ggplot(mse.df, aes(x = category, y = value)) +
    geom_violin(adjust = 1.5, 
                draw_quantiles = c(0.1, 0.5, 0.9), 
                color = &quot;red&quot;) +
    geom_jitter(position = position_jitter(0.25)) +
    labs(x = NULL, y = &quot;Difference in MSE&quot;, title = title) +
    scale_x_discrete(limits = xlimits, labels = xlabels)
  
  elbo.plot &lt;- ggplot(elbo.df, aes(x = category, y = value)) +
    geom_boxplot(colour = &quot;blue&quot;, outlier.shape = NA) + 
    geom_jitter(position = position_jitter(0.25)) +
    labs(x = NULL, y = &quot;Difference in ELBO&quot;, title = title) +
    scale_x_discrete(limits = xlimits, labels = xlabels)
  
  print(mse.plot)
  print(elbo.plot)
}

do.plots(allres$var.df, ref.lvl = &quot;constant&quot;,
         title = &quot;Variance structures (reference: Constant)&quot;,
         xlimits = c(&quot;genewise&quot;, &quot;fixed&quot;, &quot;noisyA&quot;, &quot;noisyB&quot;),
         xlabels = c(&quot;Gene-wise&quot;, &quot;Fixed&quot;, 
                     &quot;Noisy (no zero SEs)&quot;, &quot;Noisy (zero SEs)&quot;))</code></pre>
<p><img src="figure/sc_comparisons.Rmd/var_mse-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-var_mse-1">
Past versions of var_mse-1.png
</button>
</p>
<div id="fig-var_mse-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/047bb2f3c013a9db842ecf7a1646faef932ce478/docs/figure/sc_comparisons.Rmd/var_mse-1.png" target="_blank">047bb2f</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-05
</td>
</tr>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/8a15568b4a20547ba22c9b8b5de943e30a93cfcc/docs/figure/sc_comparisons.Rmd/var_mse-1.png" target="_blank">8a15568</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><img src="figure/sc_comparisons.Rmd/var_mse-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-var_mse-2">
Past versions of var_mse-2.png
</button>
</p>
<div id="fig-var_mse-2" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/047bb2f3c013a9db842ecf7a1646faef932ce478/docs/figure/sc_comparisons.Rmd/var_mse-2.png" target="_blank">047bb2f</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-05
</td>
</tr>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/8a15568b4a20547ba22c9b8b5de943e30a93cfcc/docs/figure/sc_comparisons.Rmd/var_mse-2.png" target="_blank">8a15568</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="discussion" class="section level3">
<h3>Discussion</h3>
<p>A constant variance structure clearly works best. A gene-wise variance structure is a close second.</p>
<p>Fixing standard errors generally results in a poorer fit. It’s likely that my choice of standard error for entries with zero counts is too large, since the noisy variance structure that uses the same standard errors (“Noisy (no zero SEs)”) almost always estimates <span class="math inline">\(\sigma^2\)</span> to be very close to zero (this is why results for these two variance structures are nearly identical).</p>
<p>The ELBO comparisons are not terribly meaningful. The reason why the ELBO is so high for “Noisy (zero SEs)” is simply that entries with zero counts are estimated to have very low standard errors.</p>
</div>
</div>
<div id="data-transformations" class="section level2">
<h2>Data transformations</h2>
<p>Another way to handle unequal sampling errors is to use a variance-stabilizing transformation. I compare the log1p transform to the Anscombe transform (which stabilizes variance for Poisson data): <span class="math display">\[ Y_{ij} = \sqrt{X_{ij} + \frac{3}{8}},\]</span> and the arcsine transform (which stabilizes variance for proportions): <span class="math display">\[ Y_{ij} = \text{arcsin}\left(\sqrt{\frac{X_{ij}}{\sum_j X_{ij}}}\right)\]</span> In both cases, the magnitude of the sampling errors should be similar across all entries, so it should suffice to fit a constant variance structure.</p>
<p>Note that almost all gene proportions are small, and that the arcsine function is approximately linear for small <span class="math inline">\(x\)</span>. Thus the arcsine transformation is not much different from a square-root transformation of the proportions, which in turn might not be much different from the untransformed proportions. For purposes of comparison, then, I also fit a flash object to the untransformed proportions: <span class="math display">\[ Y_{ij} = \frac{X_{ij}}{\sum_j X_{ij}} \]</span></p>
<p>Finally, I fit a flash object to Pearson residuals, using a binomial approximation to the multinomial distribution as recommended by <a href="https://www.biorxiv.org/content/10.1101/574574v1">Townes et al.</a> (The authors prefer to use deviance residuals, but transforming predicted deviance residuals to raw counts is not trivial.)</p>
<p>In all cases, I calculate mean-squared error on the log1p scale. While it is true that this might bias the results in favor of the log1p transform, it can be justified as the relative error in the fitted counts (adding a pseudocount to avoid division by zero).</p>
<p>For the log1p and Anscombe transforms, I fit an additional rank-one “mean” factor (which simply amounts to fitting 6 factors instead of 5). Since the other transforms fit scaled data, no additional mean factor needs to be fitted.</p>
<pre class="r"><code>do.plots(allres$trans.df, ref.lvl = &quot;log1p&quot;,
         title = &quot;Data transformations (reference: log1p)&quot;,
         xlimits = c(&quot;anscombe&quot;, &quot;arcsin&quot;, &quot;raw&quot;, &quot;pearson&quot;),
         xlabels = c(&quot;Anscombe&quot;, &quot;Arcsine&quot;, &quot;Proportions (raw)&quot;, &quot;Pearson&quot;))</code></pre>
<p><img src="figure/sc_comparisons.Rmd/trans_mse-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-trans_mse-1">
Past versions of trans_mse-1.png
</button>
</p>
<div id="fig-trans_mse-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/047bb2f3c013a9db842ecf7a1646faef932ce478/docs/figure/sc_comparisons.Rmd/trans_mse-1.png" target="_blank">047bb2f</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-05
</td>
</tr>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/8a15568b4a20547ba22c9b8b5de943e30a93cfcc/docs/figure/sc_comparisons.Rmd/trans_mse-1.png" target="_blank">8a15568</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><img src="figure/sc_comparisons.Rmd/trans_mse-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-trans_mse-2">
Past versions of trans_mse-2.png
</button>
</p>
<div id="fig-trans_mse-2" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/047bb2f3c013a9db842ecf7a1646faef932ce478/docs/figure/sc_comparisons.Rmd/trans_mse-2.png" target="_blank">047bb2f</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-05
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="discussion-1" class="section level3">
<h3>Discussion</h3>
<p>The Anscombe and arcsine transforms are both outperformed by the log1p transform, and (unsurprisingly) fitting the untransformed matrix of proportions generally does worst of all (but maybe not as poorly as expected). Interestingly, fitting the Pearson residuals performs nearly as poorly.</p>
<p>The log1p transform performs best in terms of both MSE and ELBO, but it also allows for a simple interpretation of factors as multiplicative effects. Further, it is possible to fit scaling factors so that loadings are comparable among one another (as discussed in the following section). (Since factors are not multiplicative under the Anscombe transform, one cannot directly fit scaling factors.)</p>
<p>(Note that in each case, the ELBO has been adjusted using a change-of-variables formula. Since the arcsine transformation is not differentiable at zero, its ELBO cannot be adjusted.)</p>
</div>
</div>
<div id="scaling-methods" class="section level2">
<h2>Scaling methods</h2>
<p>Ideally, one would like factor loadings to be comparable across genes even though mean expression can vary by several orders of magnitude. Mean expression varies much less across cells, but one should also account for differences in cell size. One way to achieve both of these goals is to add fixed mean factors to perform row- and column-specific scaling. Specifically, I fit a fixed row vector of all ones with column loadings <span class="math inline">\(c_j\)</span> to be estimated and a fixed column vector of all ones with row loadings <span class="math inline">\(r_i\)</span> to be estimated. This is approximately equivalent to estimating separate scaling factors for the rows and columns of the count data: <span class="math display">\[ X_{ij} + 1 = e^{r_i}e^{c_j} \]</span></p>
<p>Compare to the case where FLASH estimates a single rank-one factor with row loadings <span class="math inline">\(r_i\)</span> and column loadings <span class="math inline">\(c_j\)</span>: <span class="math display">\[ X_{ij} + 1 = e^{r_i c_j} \]</span> Here, the scaling factors are not independent. Do note, however, that when <span class="math inline">\(r_i\)</span> and <span class="math inline">\(c_j\)</span> are both small, <span class="math display">\[ X_{ij} = e^{r_i c_j} - 1 \approx r_i c_j, \]</span> so fitting a single factor might actually work well for small counts.</p>
<p>A third possible method scales the cells in advance (that is, before the log1p transform). Letting <span class="math inline">\(R_i\)</span> be the total count for cell <span class="math inline">\(i\)</span>, I scale each cell by the factor <span class="math display">\[ \frac{\text{median}(R_i)}{R_i} \]</span> so that, in particular, each scaled cell has the same total count. (A mean factor for genes still needs to be fit so that gene loadings are comparable.) Although this method is conceptually simpler, it risks over-relying on a few genes with large counts. In principle, a bi-scaling method like the two discussed above should be more accurate.</p>
<pre class="r"><code>do.plots(allres$norm.df, ref.lvl = &quot;none&quot;,
         title = &quot;Scaling methods (reference: Rank-1 mean factor)&quot;,
         xlimits = c(&quot;fitmean&quot;, &quot;scale&quot;),
         xlabels = c(&quot;Fixed ones vectors&quot;, &quot;Pre-scaled cells&quot;))</code></pre>
<p><img src="figure/sc_comparisons.Rmd/norm_mse-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-norm_mse-1">
Past versions of norm_mse-1.png
</button>
</p>
<div id="fig-norm_mse-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/047bb2f3c013a9db842ecf7a1646faef932ce478/docs/figure/sc_comparisons.Rmd/norm_mse-1.png" target="_blank">047bb2f</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-05
</td>
</tr>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/8a15568b4a20547ba22c9b8b5de943e30a93cfcc/docs/figure/sc_comparisons.Rmd/norm_mse-1.png" target="_blank">8a15568</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><img src="figure/sc_comparisons.Rmd/norm_mse-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-norm_mse-2">
Past versions of norm_mse-2.png
</button>
</p>
<div id="fig-norm_mse-2" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/047bb2f3c013a9db842ecf7a1646faef932ce478/docs/figure/sc_comparisons.Rmd/norm_mse-2.png" target="_blank">047bb2f</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-05
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="discussion-2" class="section level3">
<h3>Discussion</h3>
<p>All methods do about equally well. Pre-scaling cells often yields a slightly better ELBO, but can also give an ELBO that’s much worse.</p>
<p>Since it is difficult to understand exactly what the rank-one mean factor is fitting, I prefer using fixed ones vectors or pre-scaling cells when doing an in-depth analysis of a particular dataset. But the rank-one approach is easier to implement (and a bit faster), so I adopt it as the default scaling method in all other tests throughout this analysis.</p>
<p>(As above, the ELBOs have been adjusted using a change-of-variables formula.)</p>
</div>
</div>
<div id="priors" class="section level2">
<h2>Priors</h2>
<p>For simplicity, I use normal-mixture priors as the default priors throughout this analysis, but using nonnegative priors for either genes or cells can enhance interpretability. The former yields sets of genes that co-express in the same direction, with cell loadings indicating whether expression levels for the gene set are above or below the mean. The latter can work better for clustering cells, since it yields sets of cells with one set of genes that is overexpressed and a second set that is underexpressed.</p>
<p>In both cases, I test two <code>ashr</code> parameter settings. <code>method = &quot;fdr&quot;</code> includes a point mass at zero in the prior, whereas <code>method = &quot;shrink&quot;</code> includes small mixture components but no point mass. In general, <code>fdr</code> is better for false discovery rate control while <code>shrink</code> tends to be slightly more accurate.</p>
<p>Since the normal-mixture prior is in principle the most flexible of all of these priors, I don’t expect the other priors to improve on the mean squared error. The primary reason for choosing to put a nonnegative prior along one of the two dimensions is interpretability, not accuracy.</p>
<pre class="r"><code>do.plots(allres$prior.df, ref.lvl = &quot;normal&quot;,
         title = &quot;Priors (reference: Normal mixture)&quot;,
         xlimits = c(&quot;nncellA&quot;, &quot;nncellB&quot;, &quot;nngeneA&quot;, &quot;nngeneB&quot;),
         xlabels = c(&quot;NN cells (shrink)&quot;, &quot;NN cells (fdr)&quot;,
                     &quot;NN genes (shrink)&quot;, &quot;NN genes (fdr)&quot;))</code></pre>
<p><img src="figure/sc_comparisons.Rmd/prior_mse-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-prior_mse-1">
Past versions of prior_mse-1.png
</button>
</p>
<div id="fig-prior_mse-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/047bb2f3c013a9db842ecf7a1646faef932ce478/docs/figure/sc_comparisons.Rmd/prior_mse-1.png" target="_blank">047bb2f</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-05
</td>
</tr>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/8a15568b4a20547ba22c9b8b5de943e30a93cfcc/docs/figure/sc_comparisons.Rmd/prior_mse-1.png" target="_blank">8a15568</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><img src="figure/sc_comparisons.Rmd/prior_mse-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-prior_mse-2">
Past versions of prior_mse-2.png
</button>
</p>
<div id="fig-prior_mse-2" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/047bb2f3c013a9db842ecf7a1646faef932ce478/docs/figure/sc_comparisons.Rmd/prior_mse-2.png" target="_blank">047bb2f</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-05
</td>
</tr>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/8a15568b4a20547ba22c9b8b5de943e30a93cfcc/docs/figure/sc_comparisons.Rmd/prior_mse-2.png" target="_blank">8a15568</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="discussion-3" class="section level3">
<h3>Discussion</h3>
<p>In terms of mean squared error, each type of prior does approximately as well as normal-mixture priors. This is fairly surprising since 5 normal-mixture factors is in some sense equivalent to 10 semi-nonnegative factors. I’m not sure whether most of the useful information in a given factor is in one direction, or whether 5 normal-mixture factors are already beginning to overfit the data (as discussed in the following section).</p>
<p>Putting a nonnegative prior on cells (rather than genes) gives a slightly better MSE, but putting a nonnegative prior on genes generally gives a better ELBO, with marginally better results for <code>method = &quot;shrink&quot;</code>. Still, deciding whether and where to put a nonnegative prior largely comes down to a matter of preference.</p>
</div>
</div>
<div id="number-of-factors-and-backfitting" class="section level2">
<h2>Number of factors and backfitting</h2>
<p>In all previous tests, I fit 5 factors to each flash object. Here, I also fit 10 and 15 factors to see whether there’s any evidence of overfitting. Additionally, I look at how backfitting changes mean squared error.</p>
<pre class="r"><code>do.plots(allres$nfactors.df, ref.lvl = &quot;g1&quot;,
         title = &quot;Number of factors (reference: Greedy, 5 factors)&quot;,
         xlimits = c(&quot;bf1&quot;, &quot;g2&quot;, &quot;bf2&quot;, &quot;g3&quot;, &quot;bf3&quot;),
         xlabels = c(&quot;Backfit, 5 f.&quot;, &quot;Greedy, 10 f.&quot;, &quot;Backfit, 10 f.&quot;,
                     &quot;Greedy, 15 f.&quot;, &quot;Backfit, 15 f.&quot;))</code></pre>
<p><img src="figure/sc_comparisons.Rmd/nfactors_df-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-nfactors_df-1">
Past versions of nfactors_df-1.png
</button>
</p>
<div id="fig-nfactors_df-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/047bb2f3c013a9db842ecf7a1646faef932ce478/docs/figure/sc_comparisons.Rmd/nfactors_df-1.png" target="_blank">047bb2f</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-05
</td>
</tr>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/8a15568b4a20547ba22c9b8b5de943e30a93cfcc/docs/figure/sc_comparisons.Rmd/nfactors_df-1.png" target="_blank">8a15568</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-01
</td>
</tr>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/60843e039ef239f2434a2c5a38ad6d64facda2f3/docs/figure/sc_comparisons.Rmd/nfactors_df-1.png" target="_blank">60843e0</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-03-22
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><img src="figure/sc_comparisons.Rmd/nfactors_df-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-nfactors_df-2">
Past versions of nfactors_df-2.png
</button>
</p>
<div id="fig-nfactors_df-2" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/047bb2f3c013a9db842ecf7a1646faef932ce478/docs/figure/sc_comparisons.Rmd/nfactors_df-2.png" target="_blank">047bb2f</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-05
</td>
</tr>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/8a15568b4a20547ba22c9b8b5de943e30a93cfcc/docs/figure/sc_comparisons.Rmd/nfactors_df-2.png" target="_blank">8a15568</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-01
</td>
</tr>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/60843e039ef239f2434a2c5a38ad6d64facda2f3/docs/figure/sc_comparisons.Rmd/nfactors_df-2.png" target="_blank">60843e0</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-03-22
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="discussion-4" class="section level3">
<h3>Discussion</h3>
<p>The results suggest that overfitting (in the sense of predictive accuracy) occurs well before the ELBO stops improving. The ten- and fifteen-factor fits are usually worse than the five-factor fits, and the backfits are on average worse than the corresponding greedy fits.</p>
<p>To further analyze the dynamics of overfitting, I fit a single factor to the full drop-seq dataset (after removing 1% of entries at random) and calculate mean squared error, then I fit a second factor, and so on until 60 factors have been added. Even though <code>flashier</code> continues to add factors throughout the process, the mean squared error no longer improves monotonically after 31 factors, and bottoms out at 40 factors.</p>
<p>The results imply that <code>flashier</code> is unable to add the “correct” number of factors for count data, and that some type of cross validation might be needed.</p>
<pre class="r"><code>mse.df &lt;- allres$mse.df

ggplot(mse.df, aes(x = k, y = mse)) + geom_point() +
  labs(x = &quot;Number of factors&quot;, y = &quot;Mean squared error&quot;,
       title = &quot;Incremental greedy additions (full dataset)&quot;)</code></pre>
<p><img src="figure/sc_comparisons.Rmd/mse_df-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-mse_df-1">
Past versions of mse_df-1.png
</button>
</p>
<div id="fig-mse_df-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/047bb2f3c013a9db842ecf7a1646faef932ce478/docs/figure/sc_comparisons.Rmd/mse_df-1.png" target="_blank">047bb2f</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-05
</td>
</tr>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/60843e039ef239f2434a2c5a38ad6d64facda2f3/docs/figure/sc_comparisons.Rmd/mse_df-1.png" target="_blank">60843e0</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-03-22
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>ggplot(subset(mse.df, k &gt; 19), aes(x = k, y = mse)) + geom_point() +
  labs(x = &quot;Number of factors&quot;, y = &quot;Mean squared error&quot;,
       title = &quot;Incremental greedy additions (zoom)&quot;)</code></pre>
<p><img src="figure/sc_comparisons.Rmd/mse_df-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-mse_df-2">
Past versions of mse_df-2.png
</button>
</p>
<div id="fig-mse_df-2" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/047bb2f3c013a9db842ecf7a1646faef932ce478/docs/figure/sc_comparisons.Rmd/mse_df-2.png" target="_blank">047bb2f</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-04-05
</td>
</tr>
<tr>
<td>
<a href="https://github.com/willwerscheid/scFLASH/blob/60843e039ef239f2434a2c5a38ad6d64facda2f3/docs/figure/sc_comparisons.Rmd/mse_df-2.png" target="_blank">60843e0</a>
</td>
<td>
Jason Willwerscheid
</td>
<td>
2019-03-22
</td>
</tr>
</tbody>
</table>
</div>
</div>
<br> <br>
<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-sessioninfo" data-toggle="collapse" data-target="#workflowr-sessioninfo" style="display: block;">
<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span> Session information
</button>
</p>
<div id="workflowr-sessioninfo" class="collapse">
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 3.5.3 (2019-03-11)
Platform: x86_64-apple-darwin15.6.0 (64-bit)
Running under: macOS Mojave 10.14.4

Matrix products: default
BLAS: /Library/Frameworks/R.framework/Versions/3.5/Resources/lib/libRblas.0.dylib
LAPACK: /Library/Frameworks/R.framework/Versions/3.5/Resources/lib/libRlapack.dylib

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] ggplot2_3.1.0

loaded via a namespace (and not attached):
 [1] Rcpp_1.0.1       knitr_1.22       whisker_0.3-2    magrittr_1.5    
 [5] workflowr_1.2.0  tidyselect_0.2.5 munsell_0.5.0    colorspace_1.4-1
 [9] R6_2.4.0         rlang_0.3.1      dplyr_0.8.0.1    stringr_1.4.0   
[13] plyr_1.8.4       tools_3.5.3      grid_3.5.3       gtable_0.3.0    
[17] xfun_0.6         withr_2.1.2      git2r_0.25.2     htmltools_0.3.6 
[21] assertthat_0.2.1 yaml_2.2.0       lazyeval_0.2.2   rprojroot_1.3-2 
[25] digest_0.6.18    tibble_2.1.1     crayon_1.3.4     purrr_0.3.2     
[29] fs_1.2.7         glue_1.3.1       evaluate_0.13    rmarkdown_1.12  
[33] labeling_0.3     stringi_1.4.3    pillar_1.3.1     compiler_3.5.3  
[37] scales_1.0.0     backports_1.1.3  pkgconfig_2.0.2 </code></pre>
</div>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
http://docs.mathjax.org/en/latest/configuration.html.  This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
